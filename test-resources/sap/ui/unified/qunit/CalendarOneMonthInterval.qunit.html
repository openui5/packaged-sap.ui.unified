<!-- Tested control/class: sap.ui.unified.CalendarOneMonthInterval -->
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>CalendarOneMonthInterval - sap.ui.unified</title>
	<link rel="shortcut icon" type="image/x-icon" href="../images/controls/sap.ui.unified.CalendarTimeInterval.gif">
	<script src="../shared-config.js"></script>
	<script id="sap-ui-bootstrap"
			src="../../../../../resources/sap-ui-core.js"
			data-sap-ui-noConflict="true"
			data-sap-ui-libs="sap.m,sap.ui.unified"
			data-sap-ui-language="en-US">
	</script>
	<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen">
	<script src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
	<script src="../../../../../resources/sap/ui/qunit/qunit-coverage.js"></script>
	<script src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
	<!-- Sinon JS -->
	<script src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
	<script src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>
	<!--[if IE]>
	<script src="../../../../../resources/sap/ui/thirdparty/sinon-ie.js"></script>
	<![endif]-->
	<script>
		jQuery.sap.require("sap.ui.unified.calendar.CalendarUtils");
		jQuery.sap.require("sap.ui.unified.calendar.CalendarDate");
		jQuery.sap.require("sap.ui.unified.CalendarOneMonthInterval")
		var CalendarUtils = sap.ui.unified.calendar.CalendarUtils,
				CalendarDate = sap.ui.unified.calendar.CalendarDate;

		// set language to en-US, since we have specific language strings tested
		sap.ui.getCore().getConfiguration().setLanguage("en_US");

		//the SUT won't be destroyed when single test is run
		var bSkipDestroy = !!jQuery.sap.getUriParameters().get("testId");

		QUnit.module("Events", {
			beforeEach: function () {
				this.oPCStartDate = new Date(2015, 0, 1, 8, 0, 0);
				this.oPC = new sap.m.PlanningCalendar('pc1', {
					startDate: this.oPCStartDate,
					viewKey: sap.ui.unified.CalendarIntervalType.OneMonth,
					rows: [
						new sap.m.PlanningCalendarRow("pc1-Row1", {
							icon: "sap-icon://employee",
							title: "Max Mustermann",
							text: "Musterteam",
							tooltip: "Header tooltip",
							intervalHeaders: [
								new sap.ui.unified.CalendarAppointment("pc1-row1-R1H1", {
									startDate: new Date(2015, 0, 1, 9, 0),
									endDate: new Date(2015, 0, 1, 11, 0),
									type: sap.ui.unified.CalendarDayType.Type02,
									title: "SAPUI5",
									tooltip: "Test",
									icon: "sap-icon://sap-ui5"
								})
							],
							appointments: [
								new sap.ui.unified.CalendarAppointment("pc1-row1-R1A1", {
									startDate: new Date(2015, 0, 1, 8, 0),
									endDate: new Date(2015, 0, 1, 9, 0),
									type: sap.ui.unified.CalendarDayType.Type01,
									title: "App 1",
									icon: "../../ui/unified/images/m_01.png",
									tooltip: "Tooltip",
									text: "Text"
								}),
								new sap.ui.unified.CalendarAppointment("pc1-row1-R1A2", {
									startDate: new Date(2015, 0, 1, 7, 0),
									endDate: new Date(2015, 0, 1, 11, 0),
									type: sap.ui.unified.CalendarDayType.Type02,
									title: "App 2",
									icon: "sap-icon://home",
									tooltip: "Tooltip",
									text: "Text",
									tentative: true
								}),
								new sap.ui.unified.CalendarAppointment("pc1-row1-R1A3", {
									startDate: new Date(2015, 0, 2, 8, 30),
									endDate: new Date(2015, 0, 2, 9, 30),
									type: sap.ui.unified.CalendarDayType.Type03,
									title: "App3",
									icon: "sap-icon://home",
									tooltip: "Tooltip"
								}),
								new sap.ui.unified.CalendarAppointment("pc1-row1-R1A4", {
									startDate: new Date(2014, 6, 1),
									endDate: new Date(2014, 6, 2),
									type: sap.ui.unified.CalendarDayType.Type04,
									title: "Meeting 4",
									tooltip: "Tooltip 4",
									selected: true
								})
							]
						}),
						new sap.m.PlanningCalendarRow("pc1-Row2", {
							icon: "../../ui/unified/images/m_01.png",
							title: "Edward",
							text: "the great",
							tooltip: "Header tooltip",
							nonWorkingDays: [2, 3],
							nonWorkingHours: [11, 12],
							intervalHeaders: [
								new sap.ui.unified.CalendarAppointment("pc1-row2-R2H1", {
									startDate: new Date(2015, 0, 2),
									endDate: new Date(2015, 0, 2, 23, 59),
									type: sap.ui.unified.CalendarDayType.Type01,
									title: "SAPUI5",
									tooltip: "Test",
									icon: "sap-icon://sap-ui5"
								})
							],
							appointments: [
								new sap.ui.unified.CalendarAppointment("pc1-row2-R2A1", {
									startDate: new Date(2015, 0, 1),
									endDate: new Date(2015, 0, 2, 23, 59),
									type: sap.ui.unified.CalendarDayType.Type01,
									title: "App 1",
									tooltip: "Tooltip",
									text: "Text"
								})
							]
						})
					],
					specialDates: [
						new sap.ui.unified.DateTypeRange("pc1-SD1", {
							startDate: new Date(2015, 0, 6),
							type: sap.ui.unified.CalendarDayType.Type01,
							tooltip: "Heilige 3 KÃ¶nige"
						}),
						new sap.ui.unified.DateTypeRange("pc1-SD2", {
							startDate: new Date(2015, 0, 1, 12, 0),
							endDate: new Date(2015, 0, 1, 14, 0),
							type: sap.ui.unified.CalendarDayType.Type02,
							tooltip: "Lunch"
						})
					],
					toolbarContent: [new sap.m.SearchField(), new sap.m.Button()],
					appointmentSelect: function (oEvent) {
						console.log("Appointment select event fired");
					},
					startDateChange: function (oEvent) {
						console.log("Start date change event fired");
					},
					rowSelectionChange: function (oEvent) {
						console.log("Row selection change event fired");
					},
					viewChange: function (oEvent) {
						console.log("ViewChange event fired");
					},
					intervalSelect: function (oEvent) {
						console.log("IntervalSelect event fired");
					}
				});
				this.oPC.placeAt('uiArea1');
				sap.ui.getCore().applyChanges();
				this.sut = this.oPC.getAggregation("table").getAggregation("infoToolbar").getContent()[1];
				this.sutMonth = this.sut.getAggregation("month")[0];
			},
			afterEach: function () {
				if (!bSkipDestroy) {
					this.oPC.destroy();
				}
				this.oPC = undefined;
			}
		});

		QUnit.test("_focusDateExtend sets correct focused dates", function(assert) {
			//prepare
			var oSut = this.oPC._oOneMonthInterval,
					oSpyDatesRow_setDate = this.spy(this.sutMonth, "setDate"),
					oSpy_setFocusedDate = this.spy(oSut, "_setFocusedDate");
			oSut._oFocusDateOneMonth = new CalendarDate(2015, 0, 31);

			//act
			oSut._focusDateExtend();

			//assert
			assert.equal(oSpy_setFocusedDate.callCount, 1, "When this._oFocusedDateOneMonth present, it is set as focused date " +
			"(call to _setFocusedDate)");
			assert.equal(oSpy_setFocusedDate.getCall(0).args[0].toUTCJSDate().toString(), new Date(Date.UTC(2015, 0, 31)).toString(),
					"_setFocusedDate should be called with certain date parameter");

			assert.equal(oSpyDatesRow_setDate.callCount, 1, "When this._oFocusedDateOneMonth present, it is set to " +
			"datesrow(call to DatesRow#.setDate)");
			assert.equal(oSpyDatesRow_setDate.getCall(0).args[0].toString(), new Date(2015, 0, 31).toString(),
					"DatesRow#setDate should be called with certain date parameter");
		});

		QUnit.test("'_shiftStartFocusDates' shifts startDate and focusedDate according to given amount of time", function(assert) {
			//prepare
			var oSut = this.oPC._oOneMonthInterval,
				oSpy_setFocusedDate = this.spy(oSut, "_setFocusedDate"),
				oSpy_setStartDate = this.spy(oSut, "_setStartDate"),
				oStartDate = new CalendarDate(2014, 11, 1),
				oFocusedDate = new CalendarDate(2014, 11, 1),
				iDays;

			iDays = 31; //to move to the next month
			oSut._shiftStartFocusDates(oStartDate, oFocusedDate, iDays);

			//assert
			assert.equal(oSpy_setFocusedDate.getCall(0).args[0].toUTCJSDate().toString(),
					new Date(Date.UTC(2015, 0, 1)).toString(),
					"_setFocusedDate should be called with certain date parameter");
			assert.equal(oSpy_setStartDate.getCall(0).args[0].toUTCJSDate().toString(),
					new Date(Date.UTC(2015, 0, 1)).toString(),
					"_setStartDate should be called with certain date parameter");

			iDays = -31; //to move to the previous month
			oSut._shiftStartFocusDates(oStartDate, oFocusedDate, iDays);

			//assert
			assert.equal(oSpy_setFocusedDate.getCall(0).args[0].toUTCJSDate().toString(),
					new Date(Date.UTC(2014, 11, 1)).toString(),
					"_setFocusedDate should be called with certain date parameter");
			assert.equal(oSpy_setStartDate.getCall(0).args[0].toUTCJSDate().toString(),
					new Date(Date.UTC(2014, 11, 1)).toString(),
					"_setStartDate should be called with certain date parameter");
		});

		function prepareFakeEvent(sName, mParameters) {
			var oEvent = jQuery.Event(sName, {mParameters: mParameters});
			oEvent.getParameter = function (sPName) {
				return oEvent.mParameters[sPName];
			};
			oEvent.getParameters = function () {
				return oEvent.mParameters;
			};
			return oEvent;
		}

		QUnit.module("Calendar Picker");
		QUnit.test("Chosen date from the date picker is set as start date of the underying view.", function(assert) {
			// arrange
			var $Date,
				oCalP = new sap.ui.unified.CalendarOneMonthInterval("CalP",{
							startDate: new Date("2017", "7", "9"),
							pickerPopup: true
						}).placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();

			assert.ok(!jQuery("#CalP--Cal").get(0), "Calendar3: Calendar picker not initial rendered");
			qutils.triggerEvent("click", "CalP--Head-B1");
			assert.ok(jQuery("#CalP--Cal").get(0), "Calendar picker rendered");
			assert.equal(jQuery("#CalP--Cal").parent().attr("id"), "sap-ui-static", "Calendar picker rendered in static area");
			assert.ok(jQuery(jQuery("#CalP--Cal").get(0)).is(":visible"), "Calendar picker visible");

			// select May 2017
			$Date = jQuery("#CalP--Cal--MP-m4");
			$Date.focus();
			qutils.triggerKeyboardEvent($Date[0], jQuery.sap.KeyCodes.ENTER, false, false, false);

			assert.equal(sap.ui.getCore().byId("CalP").getStartDate().getMonth(), 4, "start date is set correctly");

			assert.ok(jQuery("#CalP--Cal").get(0), "Calendar picker still rendered after closing");
			assert.ok(!jQuery(jQuery("#CalP--Cal").get(0)).is(":visible"), "Calendar picker not visible after closing");

			// clean
			oCalP.destroy();
		});


		QUnit.test("fireStartDateChange", function(assert) {
			// arrange
			var $Date, oCalStartDate,
				oCalP = new sap.ui.unified.CalendarOneMonthInterval("CalP",{
							startDate: new Date("2015", "7", "9"),
							pickerPopup: true
						}),
				oSpyFireDateChange = this.spy(oCalP, "fireStartDateChange");

			oCalP.placeAt("qunit-fixture");
			sap.ui.getCore().applyChanges();

			assert.ok(!jQuery("#CalP--Cal").get(0), "Calendar picker not initial rendered");
			qutils.triggerEvent("click", "CalP--Head-B1");

			// click on Year button inside calendar picker
			qutils.triggerEvent("click", "CalP--Cal--Head-B2");
			// click on 2016
			$Date = jQuery("#CalP--Cal--YP-y20160101");
			$Date.focus();
			qutils.triggerKeyboardEvent($Date[0], jQuery.sap.KeyCodes.ENTER, false, false, false);

			// click on September
			$Date = jQuery("#CalP--Cal--MP-m8");
			$Date.focus();
			qutils.triggerKeyboardEvent($Date[0], jQuery.sap.KeyCodes.ENTER, false, false, false);

			oCalStartDate = sap.ui.getCore().byId("CalP").getStartDate();

			assert.equal(oCalStartDate.getMonth(), 8, "start date, month is set correctly");
			assert.equal(oCalStartDate.getFullYear(), 2016, "start date, year is set correctly");
			assert.strictEqual(oSpyFireDateChange.callCount, 1, "CalendarOneMonthInterval 'fireStartDateChange' was called once after selecting month, year and date");

			// clean
			oCalP.destroy();
		});


		QUnit.test("User opens the picker but escapes it - click outside for desktop or click cancel button", function(assert) {
			// arrange
			var oSpyCancel = this.spy(sap.ui.unified.CalendarOneMonthInterval.prototype, "fireCancel");
			var oCalP = new sap.ui.unified.CalendarOneMonthInterval("CalP",{
				pickerPopup: true
				}).placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();

			qutils.triggerEvent("click", "CalP--Head-B1");
			assert.ok(jQuery(jQuery("#CalP--Cal").get(0)).is(":visible"), "Calendar picker visible");

			sap.ui.test.qunit.triggerKeydown(sap.ui.getCore().byId("CalP").getFocusDomRef(), jQuery.sap.KeyCodes.ESCAPE);
			assert.ok(!jQuery(jQuery("#CalP--Cal").get(0)).is(":visible"), "Calendar picker not visible after closing");
			assert.strictEqual(oSpyCancel.callCount, 1, "CalendarOneMonthInterval 'fireCancel' was called once");

			// clean
			oCalP.destroy();
		});


		QUnit.test("Text of the direct navigation button is correct", function(assert) {
			// arrange
			var $Date,
				oCalP = new sap.ui.unified.CalendarOneMonthInterval("CalP",{
							startDate: new Date("2017", "4", "11"),
							pickerPopup: true
						}).placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();

			qutils.triggerEvent("click", "CalP--Head-B1");

			// click on December
			$Date = jQuery("#CalP--Cal--MP-m11");
			$Date.focus();
			qutils.triggerKeyboardEvent($Date[0], jQuery.sap.KeyCodes.ENTER, false, false, false);

			oCalStartDate = sap.ui.getCore().byId("CalP").getStartDate();

			assert.strictEqual(jQuery("#CalP--Head-B1").text(), "December 2017", "button text is correct");

			// clean
			oCalP.destroy();
		});


		QUnit.test("The user can select month & year, but cannot select dates", function(assert) {
			// arrange
			var $Date,
				oCalP = new sap.ui.unified.CalendarOneMonthInterval("CalP",{
							startDate: new Date("2017", "4", "11"),
							pickerPopup: true
						}).placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();

			qutils.triggerEvent("click", "CalP--Head-B1");

			assert.ok(jQuery("#CalP--Cal--MP").is(":visible"), "month picker is initialy visible");
			assert.ok(!jQuery("#CalP--Cal--Head-B0").is(":visible"), "day button is not visible");
			assert.ok(!jQuery("#CalP--Cal--Head-B1").is(":visible"), "month button is not visible");
			assert.ok(jQuery("#CalP--Cal--Head-B2").is(":visible"), "year button is visible");

			sap.ui.test.qunit.triggerKeydown(sap.ui.getCore().byId("CalP").getFocusDomRef(), jQuery.sap.KeyCodes.ESCAPE);

			// clean
			oCalP.destroy();
		});


		QUnit.test("Changing of the pickerPopup mode doesn't break min and max date inside yearPicker aggregation", function(assert) {
			// arrange
			var oCalP = new sap.ui.unified.CalendarOneMonthInterval("CalP",{
				pickerPopup: false
				}),
				oYearPicker = oCalP.getAggregation("yearPicker");

			// initialy the yearPicker has default values for min and max year
			assert.strictEqual(oYearPicker._oMinDate.getYear(), 1, "min year is set to 1");
			assert.strictEqual(oYearPicker._oMaxDate.getYear(), 9999, "max year is set to 9999");

			// change the pickerPopup to true, this will destroy the yearPicker aggregation
			oCalP.setPickerPopup(true);
			// set new min and max dates
			oCalP.setMinDate(new Date("2015", "7", "13", "8", "0", "0"));
			oCalP.setMaxDate(new Date("2017", "7", "13", "8", "0", "0"));

			// return pickrPopup property to true, this will create the yearPicker aggregation
			oCalP.setPickerPopup(false);
			oYearPicker = oCalP.getAggregation("yearPicker");

			// check if the yearPicker has the newly setted min and max date of the Interval control
			assert.strictEqual(oYearPicker._oMinDate.getYear(), 2015, "min year is set to 2015");
			assert.strictEqual(oYearPicker._oMaxDate.getYear(), 2017, "max year is set to 2017");

			// clean
			oCalP.destroy();
		});


		QUnit.test("Changing of the pickerPopup mode doesn't break min and max date inside calendarPicker aggregation", function(assert) {
			// arrange
			var oCalPicker,
				oCalP = new sap.ui.unified.CalendarOneMonthInterval("CalP",{
					pickerPopup: true
				}).placeAt("qunit-fixture");

			sap.ui.getCore().applyChanges();

			// open calendarPicker
			qutils.triggerEvent("click", "CalP--Head-B1");

			oCalPicker = oCalP.getAggregation("calendarPicker");

			// initialy the yearPicker has default values for min and max year
			assert.strictEqual(oCalPicker._oMinDate.getYear(), 1, "min year is set to 1");
			assert.strictEqual(oCalPicker._oMaxDate.getYear(), 9999, "max year is set to 9999");

			// close calendarPicker
			sap.ui.test.qunit.triggerKeydown(sap.ui.getCore().byId("CalP").getFocusDomRef(), jQuery.sap.KeyCodes.ESCAPE);
			sap.ui.getCore().applyChanges();

			// change the pickerPopup to false
			oCalP.setPickerPopup(false);
			// set new min and max dates
			oCalP.setMinDate(new Date("2015", "7", "13", "8", "0", "0"));
			oCalP.setMaxDate(new Date("2017", "7", "13", "8", "0", "0"));

			// return pickerPopup property to true, this will create the calendarPicker aggregation
			oCalP.setPickerPopup(true);

			// open calendarPicker
			qutils.triggerEvent("click", "CalP--Head-B1");

			oCalPicker = oCalP.getAggregation("calendarPicker");

			// check if the yearPicker has the newly setted min and max date of the Interval control
			assert.strictEqual(oCalPicker._oMinDate.getYear(), 2015, "min year is set to 2015");
			assert.strictEqual(oCalPicker._oMaxDate.getYear(), 2017, "max year is set to 2017");

			sap.ui.test.qunit.triggerKeydown(sap.ui.getCore().byId("CalP").getFocusDomRef(), jQuery.sap.KeyCodes.ESCAPE);
			// clean
			oCalP.destroy();
		});

	</script>
</head>
<body class="sapUiBody" role="application">
<h1 id="qunit-header">QUnit tests: sap.ui.unified.CalendarOneMonthInterval</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<div id="qunit-testrunner-toolbar"></div>
<div id="qunit-fixture"></div>
<ol id="qunit-tests"></ol>
<br>
<div id="uiArea1"></div>
<br>
<div id="uiArea2"></div>
<br>
<div id="uiArea3"></div>
</body>
</html>
